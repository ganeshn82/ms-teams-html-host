<!doctype html>
<html lang="en">
    <head>
        <title>Generic Demo Integration</title>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
	<meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://teams.microsoft.com;">
	<script src="https://res.cdn.office.net/teams-js/2.12.0/js/MicrosoftTeams.min.js"></script>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                width: 100%;
                overflow: hidden;
            }
            #td-emb-container {
                height: 100vh;
                width: 100vw;
                border: none;
            }
        </style>
	    <script src="https://res.cdn.office.net/teams-js/2.12.0/js/MicrosoftTeams.min.js"></script>
    <script>
  microsoftTeams.app.initialize().then(() => {
    microsoftTeams.media.selectMicrophone().then((mic) => {
      console.log("Microphone selected:", mic);
    }).catch((err) => {
      console.error("Error selecting microphone:", err);
    });
  });
        <script>
            const sendEventToTD = (action, data) => {
                let tdEmbContainer = document.getElementById('td-emb-container');
                tdEmbContainer.contentWindow.postMessage({ action, data }, tdEmbContainer.src);
            };

            const eventHandler = event => {
                let tdEmbContainer = document.getElementById('td-emb-container');
                if (event.origin != tdEmbContainer.src) return;
                console.log('### [custom integration] <<< event received:', event);
            };

            window.onload = () => {
                window.addEventListener('message', eventHandler);

                // âœ… Changed only this part: hardcoded 'url' to avoid redirect inside Teams
                sendEventToTD('init_td_embedded', {
                    url: 'https://teams.microsoft.com',  // <- replace with actual base URL hosting your manifest tab HTML
                    int: 'msteams',
                    env: 'prd-us',
                    aid: '5f89cb8e12c467000bed3366',
                    view: 'workspace'
                });
            };
        </script> 
    </head>
    <body>
        <iframe
            id="td-emb-container"
            title="Talkdesk Embedded"
            src="https://prd-cdn-talkdesk.talkdesk.com/talkdesk-embedded/latest/generic/index.html"
            allow="microphone; camera; autoplay; clipboard-write; notifications; display-capture; fullscreen"
            frameborder="0"
	    allowfullscreen
        ></iframe> 
 <script>
        // Initialize Teams SDK and handle authentication
        microsoftTeams.app.initialize().then(() => {
            console.log("Teams SDK initialized");
            
            // Check if this is the callback from auth
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (authCode && state) {
                // We're in the callback phase
                handleAuthCallback(authCode, state);
            } else {
                // Start the authentication flow
                startAuthFlow();
            }
        });

        function startAuthFlow() {
            console.log("Starting authentication flow");
            
            // Construct your auth URL - IMPORTANT: Use your actual auth endpoint
            const authUrl = new URL('https://your-auth-server.com/authorize');
            authUrl.searchParams.append('response_type', 'code');
            authUrl.searchParams.append('client_id', 'YOUR_CLIENT_ID');
            authUrl.searchParams.append('redirect_uri', window.location.href);
            authUrl.searchParams.append('state', 'YOUR_STATE_VALUE');
            authUrl.searchParams.append('scope', 'openid profile email');
            
            microsoftTeams.authentication.authenticate({
                url: authUrl.toString(),
                width: 600,
                height: 535,
                successCallback: function(result) {
                    console.log("Auth success:", result);
                    // The result should contain your tokens
                    sendTokensToIframe(result);
                },
                failureCallback: function(reason) {
                    console.error("Auth failed:", reason);
                    // Handle failure (show error, retry, etc.)
                }
            });
        }

        function handleAuthCallback(code, state) {
            console.log("Handling auth callback", {code, state});
            
            // Here you would typically exchange the code for tokens
            // For demo, we'll just pass them to Teams
            microsoftTeams.authentication.notifySuccess({
                code: code,
                state: state
            });
            
            // Alternative: Send to your iframe
            sendTokensToIframe({code, state});
        }

        function sendTokensToIframe(tokenData) {
            const iframe = document.getElementById('td-emb-container');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({
                    action: 'auth_tokens',
                    tokens: tokenData
                }, iframe.src);
            }
        }
    </script>
    </body>
</html>

